import { Directive, Input, Output, EventEmitter, Inject, Optional, HostListener, } from '@angular/core';
import { Router, NavigationEnd, NavigationError, NavigationCancel } from '@angular/router';
import { DOCUMENT } from '@angular/common';
import { PageScrollService } from './mdb-page-scroll.service';
import { PageScrollInstance } from './mdb-page-scroll.instance';
import { PageScrollUtilService as Util } from './mdb-page-scroll-util.service';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './mdb-page-scroll.service';
import * as ɵngcc2 from '@angular/router';
export class PageScrollDirective {
    constructor(pageScrollService, router, document) {
        this.pageScrollService = pageScrollService;
        this.router = router;
        this.pageScrollHorizontal = null;
        this.pageScrollOffset = null;
        this.pageScrollDuration = null;
        this.pageScrollSpeed = null;
        this.pageScrollEasing = null;
        this.pageScrollAdjustHash = false;
        this.pageScroll = null;
        this.pageScrollFinish = new EventEmitter();
        this.document = document;
    }
    ngOnChanges() {
        // Some inputs changed, reset the pageScrollInstance
        this.pageScrollInstance = undefined;
    }
    ngOnDestroy() {
        if (this.pageScrollInstance) {
            this.pageScrollService.stop(this.pageScrollInstance);
        }
        return undefined;
    }
    generatePageScrollInstance() {
        if (Util.isUndefinedOrNull(this.pageScrollInstance)) {
            this.pageScrollInstance = PageScrollInstance.newInstance({
                document: this.document,
                scrollTarget: this.href,
                scrollingViews: null,
                namespace: this.pageScroll,
                verticalScrolling: !this.pageScrollHorizontal,
                pageScrollOffset: this.pageScrollOffset,
                pageScrollInterruptible: this.pageScrollInterruptible,
                pageScrollEasingLogic: this.pageScrollEasing,
                pageScrollDuration: this.pageScrollDuration,
                pageScrollSpeed: this.pageScrollSpeed,
                pageScrollFinishListener: this.pageScrollFinish,
            });
        }
        return this.pageScrollInstance;
    }
    pushRouterState() {
        if (this.pageScrollAdjustHash &&
            typeof this.pageScrollInstance.scrollTarget === 'string' &&
            this.pageScrollInstance.scrollTarget.substr(0, 1) === '#') {
            // "Navigate" to the current route again and this time set the fragment/hash
            this.router.navigate([], {
                fragment: this.pageScrollInstance.scrollTarget.substr(1),
                queryParamsHandling: 'preserve',
            });
        }
    }
    scroll() {
        const pageScrollInstance = this.generatePageScrollInstance();
        this.pushRouterState();
        this.pageScrollService.start(pageScrollInstance);
    }
    handleClick() {
        if (this.routerLink && this.router !== null && this.router !== undefined) {
            let urlTree;
            if (typeof this.routerLink === 'string') {
                urlTree = this.router.parseUrl(this.routerLink);
            }
            else {
                urlTree = this.router.createUrlTree(this.routerLink);
            }
            if (!this.router.isActive(urlTree, true)) {
                // We need to navigate their first.
                // Navigation is handled by the routerLink directive
                // so we only need to listen for route change
                const subscription = this.router.events.subscribe(routerEvent => {
                    if (routerEvent instanceof NavigationEnd) {
                        subscription.unsubscribe();
                        this.scroll();
                    }
                    else if (routerEvent instanceof NavigationError ||
                        routerEvent instanceof NavigationCancel) {
                        subscription.unsubscribe();
                    }
                });
                return false; // to preventDefault()
            }
        }
        this.scroll();
        return false; // to preventDefault()
    }
}
PageScrollDirective.ɵfac = function PageScrollDirective_Factory(t) { return new (t || PageScrollDirective)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.PageScrollService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.Router, 8), ɵngcc0.ɵɵdirectiveInject(DOCUMENT)); };
PageScrollDirective.ɵdir = ɵngcc0.ɵɵdefineDirective({ type: PageScrollDirective, selectors: [["", "mdbPageScroll", ""]], hostBindings: function PageScrollDirective_HostBindings(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵlistener("click", function PageScrollDirective_click_HostBindingHandler() { return ctx.handleClick(); });
    } }, inputs: { pageScrollHorizontal: "pageScrollHorizontal", pageScrollOffset: "pageScrollOffset", pageScrollDuration: "pageScrollDuration", pageScrollSpeed: "pageScrollSpeed", pageScrollEasing: "pageScrollEasing", pageScrollAdjustHash: "pageScrollAdjustHash", pageScroll: "pageScroll", routerLink: "routerLink", href: "href", pageScrollInterruptible: "pageScrollInterruptible" }, outputs: { pageScrollFinish: "pageScrollFinish" }, features: [ɵngcc0.ɵɵNgOnChangesFeature] });
PageScrollDirective.ctorParameters = () => [
    { type: PageScrollService },
    { type: Router, decorators: [{ type: Optional }] },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
];
PageScrollDirective.propDecorators = {
    routerLink: [{ type: Input }],
    href: [{ type: Input }],
    pageScrollHorizontal: [{ type: Input }],
    pageScrollOffset: [{ type: Input }],
    pageScrollDuration: [{ type: Input }],
    pageScrollSpeed: [{ type: Input }],
    pageScrollEasing: [{ type: Input }],
    pageScrollInterruptible: [{ type: Input }],
    pageScrollAdjustHash: [{ type: Input }],
    pageScroll: [{ type: Input }],
    pageScrollFinish: [{ type: Output }],
    handleClick: [{ type: HostListener, args: ['click',] }]
};
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(PageScrollDirective, [{
        type: Directive,
        args: [{
                selector: '[mdbPageScroll]'
            }]
    }], function () { return [{ type: ɵngcc1.PageScrollService }, { type: ɵngcc2.Router, decorators: [{
                type: Optional
            }] }, { type: undefined, decorators: [{
                type: Inject,
                args: [DOCUMENT]
            }] }]; }, { pageScrollHorizontal: [{
            type: Input
        }], pageScrollOffset: [{
            type: Input
        }], pageScrollDuration: [{
            type: Input
        }], pageScrollSpeed: [{
            type: Input
        }], pageScrollEasing: [{
            type: Input
        }], pageScrollAdjustHash: [{
            type: Input
        }], pageScroll: [{
            type: Input
        }], pageScrollFinish: [{
            type: Output
        }], handleClick: [{
            type: HostListener,
            args: ['click']
        }], routerLink: [{
            type: Input
        }], href: [{
            type: Input
        }], pageScrollInterruptible: [{
            type: Input
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWRiLXBhZ2Utc2Nyb2xsLmRpcmVjdGl2ZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmctdWlraXQtcHJvLXN0YW5kYXJkL3NyYy9saWIvcHJvL3Ntb290aHNjcm9sbC9tZGItcGFnZS1zY3JvbGwuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsS0FBSyxFQUNMLE1BQU0sRUFDTixZQUFZLEVBRVosTUFBTSxFQUNOLFFBQVEsRUFFUixZQUFZLEdBQ2IsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLE1BQU0sRUFBRSxhQUFhLEVBQUUsZUFBZSxFQUFFLGdCQUFnQixFQUFXLE1BQU0saUJBQWlCLENBQUM7QUFDcEcsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBSTNDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQzlELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQ2hFLE9BQU8sRUFBRSxxQkFBcUIsSUFBSSxJQUFJLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQzs7OztBQU0vRSxNQUFNLE9BQU8sbUJBQW1CO0FBQUcsSUFpQmpDLFlBQ1UsaUJBQW9DLEVBQ3hCLE1BQWMsRUFDaEIsUUFBYTtBQUNoQyxRQUhTLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7QUFBQyxRQUN6QixXQUFNLEdBQU4sTUFBTSxDQUFRO0FBQUMsUUFoQnJCLHlCQUFvQixHQUFrQixJQUFJLENBQUM7QUFDN0QsUUFBa0IscUJBQWdCLEdBQWlCLElBQUksQ0FBQztBQUN4RCxRQUFrQix1QkFBa0IsR0FBaUIsSUFBSSxDQUFDO0FBQzFELFFBQWtCLG9CQUFlLEdBQWlCLElBQUksQ0FBQztBQUN2RCxRQUFrQixxQkFBZ0IsR0FBc0IsSUFBSSxDQUFDO0FBQzdELFFBQ2tCLHlCQUFvQixHQUFHLEtBQUssQ0FB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QUM7QUFBNkMsWUFSMUMsaUJBQWlCO0FBQUksWUFMckIsTUFBTSx1QkFnQ1YsUUFBUTtBQUFPLDRDQUNmLE1BQU0sU0FBQyxRQUFRO0FBQVE7QUFBRztBQUVILHlCQXJCekIsS0FBSztBQUFLLG1CQUNWLEtBQUs7QUFBSyxtQ0FDVixLQUFLO0FBQUssK0JBQ1YsS0FBSztBQUFLLGlDQUNWLEtBQUs7QUFBSyw4QkFDVixLQUFLO0FBQUssK0JBQ1YsS0FBSztBQUFLLHNDQUNWLEtBQUs7QUFBSyxtQ0FDVixLQUFLO0FBQUsseUJBQ1YsS0FBSztBQUFLLCtCQUVWLE1BQU07QUFBSywwQkFnRVgsWUFBWSxTQUFDLE9BQU87QUFDbkI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztvQkFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRGlyZWN0aXZlLFxuICBJbnB1dCxcbiAgT3V0cHV0LFxuICBFdmVudEVtaXR0ZXIsXG4gIE9uRGVzdHJveSxcbiAgSW5qZWN0LFxuICBPcHRpb25hbCxcbiAgT25DaGFuZ2VzLFxuICBIb3N0TGlzdGVuZXIsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUm91dGVyLCBOYXZpZ2F0aW9uRW5kLCBOYXZpZ2F0aW9uRXJyb3IsIE5hdmlnYXRpb25DYW5jZWwsIFVybFRyZWUgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuXG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgUGFnZVNjcm9sbFNlcnZpY2UgfSBmcm9tICcuL21kYi1wYWdlLXNjcm9sbC5zZXJ2aWNlJztcbmltcG9ydCB7IFBhZ2VTY3JvbGxJbnN0YW5jZSB9IGZyb20gJy4vbWRiLXBhZ2Utc2Nyb2xsLmluc3RhbmNlJztcbmltcG9ydCB7IFBhZ2VTY3JvbGxVdGlsU2VydmljZSBhcyBVdGlsIH0gZnJvbSAnLi9tZGItcGFnZS1zY3JvbGwtdXRpbC5zZXJ2aWNlJztcbmltcG9ydCB7IEVhc2luZ0xvZ2ljIH0gZnJvbSAnLi9tZGItcGFnZS1zY3JvbGwuY29uZmlnJztcblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnW21kYlBhZ2VTY3JvbGxdJyxcbn0pXG5leHBvcnQgY2xhc3MgUGFnZVNjcm9sbERpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcbiAgQElucHV0KCkgcHVibGljIHJvdXRlckxpbms6IGFueTtcbiAgQElucHV0KCkgcHVibGljIGhyZWY6IHN0cmluZztcbiAgQElucHV0KCkgcHVibGljIHBhZ2VTY3JvbGxIb3Jpem9udGFsOiBib29sZWFuIHwgYW55ID0gbnVsbDtcbiAgQElucHV0KCkgcHVibGljIHBhZ2VTY3JvbGxPZmZzZXQ6IG51bWJlciB8IGFueSA9IG51bGw7XG4gIEBJbnB1dCgpIHB1YmxpYyBwYWdlU2Nyb2xsRHVyYXRpb246IG51bWJlciB8IGFueSA9IG51bGw7XG4gIEBJbnB1dCgpIHB1YmxpYyBwYWdlU2Nyb2xsU3BlZWQ6IG51bWJlciB8IGFueSA9IG51bGw7XG4gIEBJbnB1dCgpIHB1YmxpYyBwYWdlU2Nyb2xsRWFzaW5nOiBFYXNpbmdMb2dpYyB8IGFueSA9IG51bGw7XG4gIEBJbnB1dCgpIHB1YmxpYyBwYWdlU2Nyb2xsSW50ZXJydXB0aWJsZTogYm9vbGVhbjtcbiAgQElucHV0KCkgcHVibGljIHBhZ2VTY3JvbGxBZGp1c3RIYXNoID0gZmFsc2U7XG4gIEBJbnB1dCgpIHB1YmxpYyBwYWdlU2Nyb2xsOiBzdHJpbmcgfCBhbnkgPSBudWxsO1xuXG4gIEBPdXRwdXQoKSBwYWdlU2Nyb2xsRmluaXNoOiBFdmVudEVtaXR0ZXI8Ym9vbGVhbj4gPSBuZXcgRXZlbnRFbWl0dGVyPGJvb2xlYW4+KCk7XG5cbiAgcHJpdmF0ZSBwYWdlU2Nyb2xsSW5zdGFuY2U6IFBhZ2VTY3JvbGxJbnN0YW5jZSB8IGFueTtcbiAgcHJpdmF0ZSBkb2N1bWVudDogRG9jdW1lbnQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBwYWdlU2Nyb2xsU2VydmljZTogUGFnZVNjcm9sbFNlcnZpY2UsXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlcixcbiAgICBASW5qZWN0KERPQ1VNRU5UKSBkb2N1bWVudDogYW55XG4gICkge1xuICAgIHRoaXMuZG9jdW1lbnQgPSA8RG9jdW1lbnQ+ZG9jdW1lbnQ7XG4gIH1cblxuICBuZ09uQ2hhbmdlcygpOiB2b2lkIHtcbiAgICAvLyBTb21lIGlucHV0cyBjaGFuZ2VkLCByZXNldCB0aGUgcGFnZVNjcm9sbEluc3RhbmNlXG4gICAgdGhpcy5wYWdlU2Nyb2xsSW5zdGFuY2UgPSB1bmRlZmluZWQ7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5wYWdlU2Nyb2xsSW5zdGFuY2UpIHtcbiAgICAgIHRoaXMucGFnZVNjcm9sbFNlcnZpY2Uuc3RvcCh0aGlzLnBhZ2VTY3JvbGxJbnN0YW5jZSk7XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBwcml2YXRlIGdlbmVyYXRlUGFnZVNjcm9sbEluc3RhbmNlKCk6IFBhZ2VTY3JvbGxJbnN0YW5jZSB8IGFueSB7XG4gICAgaWYgKFV0aWwuaXNVbmRlZmluZWRPck51bGwodGhpcy5wYWdlU2Nyb2xsSW5zdGFuY2UpKSB7XG4gICAgICB0aGlzLnBhZ2VTY3JvbGxJbnN0YW5jZSA9IFBhZ2VTY3JvbGxJbnN0YW5jZS5uZXdJbnN0YW5jZSh7XG4gICAgICAgIGRvY3VtZW50OiB0aGlzLmRvY3VtZW50LFxuICAgICAgICBzY3JvbGxUYXJnZXQ6IHRoaXMuaHJlZixcbiAgICAgICAgc2Nyb2xsaW5nVmlld3M6IG51bGwsXG4gICAgICAgIG5hbWVzcGFjZTogdGhpcy5wYWdlU2Nyb2xsLFxuICAgICAgICB2ZXJ0aWNhbFNjcm9sbGluZzogIXRoaXMucGFnZVNjcm9sbEhvcml6b250YWwsXG4gICAgICAgIHBhZ2VTY3JvbGxPZmZzZXQ6IHRoaXMucGFnZVNjcm9sbE9mZnNldCxcbiAgICAgICAgcGFnZVNjcm9sbEludGVycnVwdGlibGU6IHRoaXMucGFnZVNjcm9sbEludGVycnVwdGlibGUsXG4gICAgICAgIHBhZ2VTY3JvbGxFYXNpbmdMb2dpYzogdGhpcy5wYWdlU2Nyb2xsRWFzaW5nLFxuICAgICAgICBwYWdlU2Nyb2xsRHVyYXRpb246IHRoaXMucGFnZVNjcm9sbER1cmF0aW9uLFxuICAgICAgICBwYWdlU2Nyb2xsU3BlZWQ6IHRoaXMucGFnZVNjcm9sbFNwZWVkLFxuICAgICAgICBwYWdlU2Nyb2xsRmluaXNoTGlzdGVuZXI6IHRoaXMucGFnZVNjcm9sbEZpbmlzaCxcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5wYWdlU2Nyb2xsSW5zdGFuY2U7XG4gIH1cblxuICBwcml2YXRlIHB1c2hSb3V0ZXJTdGF0ZSgpIHtcbiAgICBpZiAoXG4gICAgICB0aGlzLnBhZ2VTY3JvbGxBZGp1c3RIYXNoICYmXG4gICAgICB0eXBlb2YgdGhpcy5wYWdlU2Nyb2xsSW5zdGFuY2Uuc2Nyb2xsVGFyZ2V0ID09PSAnc3RyaW5nJyAmJlxuICAgICAgdGhpcy5wYWdlU2Nyb2xsSW5zdGFuY2Uuc2Nyb2xsVGFyZ2V0LnN1YnN0cigwLCAxKSA9PT0gJyMnXG4gICAgKSB7XG4gICAgICAvLyBcIk5hdmlnYXRlXCIgdG8gdGhlIGN1cnJlbnQgcm91dGUgYWdhaW4gYW5kIHRoaXMgdGltZSBzZXQgdGhlIGZyYWdtZW50L2hhc2hcbiAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFtdLCB7XG4gICAgICAgIGZyYWdtZW50OiA8c3RyaW5nPnRoaXMucGFnZVNjcm9sbEluc3RhbmNlLnNjcm9sbFRhcmdldC5zdWJzdHIoMSksXG4gICAgICAgIHF1ZXJ5UGFyYW1zSGFuZGxpbmc6ICdwcmVzZXJ2ZScsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNjcm9sbCgpOiB2b2lkIHtcbiAgICBjb25zdCBwYWdlU2Nyb2xsSW5zdGFuY2UgPSB0aGlzLmdlbmVyYXRlUGFnZVNjcm9sbEluc3RhbmNlKCk7XG4gICAgdGhpcy5wdXNoUm91dGVyU3RhdGUoKTtcbiAgICB0aGlzLnBhZ2VTY3JvbGxTZXJ2aWNlLnN0YXJ0KHBhZ2VTY3JvbGxJbnN0YW5jZSk7XG4gIH1cblxuICBASG9zdExpc3RlbmVyKCdjbGljaycpXG4gIHB1YmxpYyBoYW5kbGVDbGljaygpOiBib29sZWFuIHtcbiAgICBpZiAodGhpcy5yb3V0ZXJMaW5rICYmIHRoaXMucm91dGVyICE9PSBudWxsICYmIHRoaXMucm91dGVyICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGxldCB1cmxUcmVlOiBVcmxUcmVlO1xuICAgICAgaWYgKHR5cGVvZiB0aGlzLnJvdXRlckxpbmsgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHVybFRyZWUgPSB0aGlzLnJvdXRlci5wYXJzZVVybCh0aGlzLnJvdXRlckxpbmspO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdXJsVHJlZSA9IHRoaXMucm91dGVyLmNyZWF0ZVVybFRyZWUodGhpcy5yb3V0ZXJMaW5rKTtcbiAgICAgIH1cbiAgICAgIGlmICghdGhpcy5yb3V0ZXIuaXNBY3RpdmUodXJsVHJlZSwgdHJ1ZSkpIHtcbiAgICAgICAgLy8gV2UgbmVlZCB0byBuYXZpZ2F0ZSB0aGVpciBmaXJzdC5cbiAgICAgICAgLy8gTmF2aWdhdGlvbiBpcyBoYW5kbGVkIGJ5IHRoZSByb3V0ZXJMaW5rIGRpcmVjdGl2ZVxuICAgICAgICAvLyBzbyB3ZSBvbmx5IG5lZWQgdG8gbGlzdGVuIGZvciByb3V0ZSBjaGFuZ2VcbiAgICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb24gPSA8U3Vic2NyaXB0aW9uPnRoaXMucm91dGVyLmV2ZW50cy5zdWJzY3JpYmUoXG4gICAgICAgICAgcm91dGVyRXZlbnQgPT4ge1xuICAgICAgICAgICAgaWYgKHJvdXRlckV2ZW50IGluc3RhbmNlb2YgTmF2aWdhdGlvbkVuZCkge1xuICAgICAgICAgICAgICBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgICAgdGhpcy5zY3JvbGwoKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoXG4gICAgICAgICAgICAgIHJvdXRlckV2ZW50IGluc3RhbmNlb2YgTmF2aWdhdGlvbkVycm9yIHx8XG4gICAgICAgICAgICAgIHJvdXRlckV2ZW50IGluc3RhbmNlb2YgTmF2aWdhdGlvbkNhbmNlbFxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgIHN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlOyAvLyB0byBwcmV2ZW50RGVmYXVsdCgpXG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuc2Nyb2xsKCk7XG4gICAgcmV0dXJuIGZhbHNlOyAvLyB0byBwcmV2ZW50RGVmYXVsdCgpXG4gIH1cbn1cbiJdfQ==