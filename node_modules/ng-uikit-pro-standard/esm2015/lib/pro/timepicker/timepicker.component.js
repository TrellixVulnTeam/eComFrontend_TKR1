import { Component, ViewEncapsulation, ChangeDetectionStrategy, ViewContainerRef, Input, Output, EventEmitter, } from '@angular/core';
import { Overlay, OverlayConfig } from '@angular/cdk/overlay';
import { ComponentPortal } from '@angular/cdk/portal';
import { merge } from 'rxjs';
import { filter } from 'rxjs/operators';
import { ESCAPE } from '../../free/utils/keyboard-navigation';
import { MdbTimePickerContentComponent } from './timepicker.content';
import { Subject } from 'rxjs';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/cdk/overlay';
export class MdbTimePickerComponent {
    constructor(_overlay, _vcr // private _cdRef: ChangeDetectorRef
    ) {
        this._overlay = _overlay;
        this._vcr = _vcr;
        this.autoClose = false;
        this.clearButton = 'clear';
        this.closeButton = 'close';
        this.okButton = 'ok';
        this.rounding = 1;
        this.twelveHour = true;
        this.timeChange = new EventEmitter();
        this.cancel = new EventEmitter();
        this.done = new EventEmitter();
        this.show = new EventEmitter();
        this._value = '12:00AM';
        this._selectionChange$ = new Subject();
        this.onChangeCb = () => { };
        this.onTouchedCb = () => { };
    }
    _patchInputValues() {
        this._contentRef.instance.picker = this;
        this._contentRef.instance.autoClose = this.autoClose;
        this._contentRef.instance.clearButton = this.clearButton;
        this._contentRef.instance.closeButton = this.closeButton;
        this._contentRef.instance.okButton = this.okButton;
        this._contentRef.instance.rounding = this.rounding;
        this._contentRef.instance.twelveHour = this.twelveHour;
        this._contentRef.instance.value = this._timeToObj(this._value);
        if (this.max) {
            this._contentRef.instance.max = this._timeToObj(this.max);
        }
        if (this.min) {
            this._contentRef.instance.min = this._timeToObj(this.min);
        }
    }
    _timeToObj(time) {
        const round = (x, roundBy) => {
            return x % roundBy < Math.round(roundBy / 2)
                ? x % roundBy === 0
                    ? x
                    : Math.ceil(x / roundBy) * roundBy
                : Math.floor(x / roundBy) * roundBy;
        };
        function toString(val) {
            return val < 10 ? `0${val}` : `${val}`;
        }
        const hour = Number(time.split(':')[0]);
        let minute = Number(time.split(':')[1].match(/\d+/g));
        const ampm = time.match(/AM|PM/) || [''];
        if (this.rounding) {
            minute = round(minute, this.rounding);
        }
        return {
            h: toString(hour),
            m: toString(minute),
            ampm: ampm[0],
        };
    }
    open() {
        let overlayRef = this._overlayRef;
        if (!overlayRef) {
            this._portal = new ComponentPortal(MdbTimePickerContentComponent, this._vcr);
            overlayRef = this._overlay.create(this._getOverlayConfig());
            this._overlayRef = overlayRef;
        }
        if (overlayRef && this._overlayRef && !overlayRef.hasAttached()) {
            this._contentRef = this._overlayRef.attach(this._portal);
            this._patchInputValues();
            this._listenToOutsideClick();
        }
        this._emitTimeShowEvent(this._timeToObj(this._value));
    }
    close(doneClicked, value) {
        if (this._overlayRef && this._overlayRef.hasAttached()) {
            if (!doneClicked) {
                this._emitTimeCancelEvent(value || this._timeToObj(this._value));
            }
        }
        this._destroyOverlay();
    }
    _emitTimeChangeEvent(value) {
        this.timeChange.emit({ status: 'change', value });
    }
    _emitTimeCancelEvent(value) {
        this.cancel.emit({ status: 'cancel', value });
    }
    _emitTimeDoneEvent(value) {
        const { h, m, ampm } = value;
        this.done.emit({ status: 'done', value });
        this._selectionChange$.next(this.twelveHour ? `${h}:${m}${ampm}` : `${h}:${m}`);
    }
    _emitTimeShowEvent(value) {
        this.show.emit({ status: 'open', value });
    }
    _setValue(value) {
        if (value) {
            this._value = value;
        }
        else {
            this._value = '12:00AM';
        }
    }
    setInput(input) {
        this.input = input;
        input._valueChange.subscribe((val) => {
            const match = val.match(/\d\d:\d\d(AM|PM)?/gi);
            if (match) {
                this._value = match[0];
            }
            else {
                this._value = '12:00AM';
            }
        });
    }
    registerOnChange(fn) {
        this.onChangeCb = fn;
    }
    registerOnTouched(fn) {
        this.onTouchedCb = fn;
    }
    _getOverlayConfig() {
        const positionStrategy = this._overlay
            .position()
            .global()
            .centerHorizontally()
            .centerVertically();
        const overlayConfig = new OverlayConfig({
            hasBackdrop: true,
            scrollStrategy: this._overlay.scrollStrategies.block(),
            positionStrategy,
        });
        return overlayConfig;
    }
    _destroyOverlay() {
        if (this._overlayRef) {
            this._overlayRef.dispose();
            this._overlayRef = null;
        }
    }
    _listenToOutsideClick() {
        if (this._overlayRef) {
            merge(this._overlayRef.backdropClick(), this._overlayRef.detachments(), this._overlayRef.keydownEvents().pipe(filter((event) => {
                // Closing on alt + up is only valid when there's an input associated with the datepicker.
                // tslint:disable-next-line: deprecation
                return event.keyCode === ESCAPE;
            }))).subscribe(event => {
                if (event) {
                    event.preventDefault();
                }
                this.close();
                this._destroyOverlay();
            });
        }
    }
    ngOnDestroy() {
        this._destroyOverlay();
    }
}
MdbTimePickerComponent.ɵfac = function MdbTimePickerComponent_Factory(t) { return new (t || MdbTimePickerComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.Overlay), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ViewContainerRef)); };
MdbTimePickerComponent.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: MdbTimePickerComponent, selectors: [["mdb-timepicker"]], inputs: { autoClose: "autoClose", clearButton: "clearButton", closeButton: "closeButton", okButton: "okButton", rounding: "rounding", twelveHour: "twelveHour", max: "max", min: "min" }, outputs: { timeChange: "timeChange", cancel: "cancel", done: "done", show: "show" }, exportAs: ["mdbTimePicker"], decls: 0, vars: 0, template: function MdbTimePickerComponent_Template(rf, ctx) { }, encapsulation: 2, changeDetection: 0 });
MdbTimePickerComponent.ctorParameters = () => [
    { type: Overlay },
    { type: ViewContainerRef }
];
MdbTimePickerComponent.propDecorators = {
    autoClose: [{ type: Input }],
    clearButton: [{ type: Input }],
    closeButton: [{ type: Input }],
    max: [{ type: Input }],
    min: [{ type: Input }],
    okButton: [{ type: Input }],
    rounding: [{ type: Input }],
    twelveHour: [{ type: Input }],
    timeChange: [{ type: Output }],
    cancel: [{ type: Output }],
    done: [{ type: Output }],
    show: [{ type: Output }]
};
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(MdbTimePickerComponent, [{
        type: Component,
        args: [{
                template: '',
                selector: 'mdb-timepicker',
                exportAs: 'mdbTimePicker',
                encapsulation: ViewEncapsulation.None,
                changeDetection: ChangeDetectionStrategy.OnPush
            }]
    }], function () { return [{ type: ɵngcc1.Overlay }, { type: ɵngcc0.ViewContainerRef }]; }, { autoClose: [{
            type: Input
        }], clearButton: [{
            type: Input
        }], closeButton: [{
            type: Input
        }], okButton: [{
            type: Input
        }], rounding: [{
            type: Input
        }], twelveHour: [{
            type: Input
        }], timeChange: [{
            type: Output
        }], cancel: [{
            type: Output
        }], done: [{
            type: Output
        }], show: [{
            type: Output
        }], max: [{
            type: Input
        }], min: [{
            type: Input
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZXBpY2tlci5jb21wb25lbnQuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25nLXVpa2l0LXByby1zdGFuZGFyZC9zcmMvbGliL3Byby90aW1lcGlja2VyL3RpbWVwaWNrZXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsaUJBQWlCLEVBQ2pCLHVCQUF1QixFQUN2QixnQkFBZ0IsRUFFaEIsS0FBSyxFQUNMLE1BQU0sRUFDTixZQUFZLEdBRWIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFjLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUMxRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdEQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQzlELE9BQU8sRUFBRSw2QkFBNkIsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRXJFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7OztBQVMvQixNQUFNLE9BQU8sc0JBQXNCO0FBQUcsSUF1QnBDLFlBQ1UsUUFBaUIsRUFDakIsSUFBc0IsQ0FBQyxvQ0FBb0M7QUFBQztBQUNqRSxRQUZLLGFBQVEsR0FBUixRQUFRLENBQVM7QUFBQyxRQUNsQixTQUFJLEdBQUosSUFBSSxDQUFrQjtBQUFDLFFBeEJ4QixjQUFTLEdBQUcsS0FBSyxDQUFDO0FBQUMsUUFDbkIsZ0JBQVcsR0FBZ0IsT0FBTyxDQUFDO0FBQUMsUUFDcEMsZ0JBQVcsR0FBZ0IsT0FBTyxDQUFDO0FBQUMsUUFHcEMsYUFBUSxHQUFHLElBQUksQ0FBQztBQUFDLFFBQ2pCLGFBQVEsR0FBYSxDQUFDLENBQUM7QUFB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O0FBQUssdUJBQ1YsS0FBSztBQUFLLHlCQUNWLEtBQUs7QUFBSyx5QkFFVixNQUFNO0FBQUsscUJBQ1gsTUFBTTtBQUFLLG1CQUNYLE1BQU07QUFBSyxtQkFDWCxNQUFNO0FBQUk7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7b0JBQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgQ29tcG9uZW50LFxyXG4gIFZpZXdFbmNhcHN1bGF0aW9uLFxyXG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxyXG4gIFZpZXdDb250YWluZXJSZWYsXHJcbiAgQ29tcG9uZW50UmVmLFxyXG4gIElucHV0LFxyXG4gIE91dHB1dCxcclxuICBFdmVudEVtaXR0ZXIsXHJcbiAgT25EZXN0cm95LFxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBPdmVybGF5UmVmLCBPdmVybGF5LCBPdmVybGF5Q29uZmlnIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL292ZXJsYXknO1xyXG5pbXBvcnQgeyBDb21wb25lbnRQb3J0YWwgfSBmcm9tICdAYW5ndWxhci9jZGsvcG9ydGFsJztcclxuaW1wb3J0IHsgbWVyZ2UgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgZmlsdGVyIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBFU0NBUEUgfSBmcm9tICcuLi8uLi9mcmVlL3V0aWxzL2tleWJvYXJkLW5hdmlnYXRpb24nO1xyXG5pbXBvcnQgeyBNZGJUaW1lUGlja2VyQ29udGVudENvbXBvbmVudCB9IGZyb20gJy4vdGltZXBpY2tlci5jb250ZW50JztcclxuaW1wb3J0IHsgQ2xlYXJCdXR0b24sIFJvdW5kaW5nLCBTZWxlY3RlZFRpbWUsIENsb3NlQnV0dG9uIH0gZnJvbSAnLi90aW1lcGlja2VyLmludGVyZmFjZSc7XHJcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIHRlbXBsYXRlOiAnJyxcclxuICBzZWxlY3RvcjogJ21kYi10aW1lcGlja2VyJyxcclxuICBleHBvcnRBczogJ21kYlRpbWVQaWNrZXInLFxyXG4gIGVuY2Fwc3VsYXRpb246IFZpZXdFbmNhcHN1bGF0aW9uLk5vbmUsXHJcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBNZGJUaW1lUGlja2VyQ29tcG9uZW50IGltcGxlbWVudHMgT25EZXN0cm95IHtcclxuICBASW5wdXQoKSBhdXRvQ2xvc2UgPSBmYWxzZTtcclxuICBASW5wdXQoKSBjbGVhckJ1dHRvbjogQ2xlYXJCdXR0b24gPSAnY2xlYXInO1xyXG4gIEBJbnB1dCgpIGNsb3NlQnV0dG9uOiBDbG9zZUJ1dHRvbiA9ICdjbG9zZSc7XHJcbiAgQElucHV0KCkgbWF4OiBzdHJpbmc7XHJcbiAgQElucHV0KCkgbWluOiBzdHJpbmc7XHJcbiAgQElucHV0KCkgb2tCdXR0b24gPSAnb2snO1xyXG4gIEBJbnB1dCgpIHJvdW5kaW5nOiBSb3VuZGluZyA9IDE7XHJcbiAgQElucHV0KCkgdHdlbHZlSG91ciA9IHRydWU7XHJcblxyXG4gIEBPdXRwdXQoKSB0aW1lQ2hhbmdlOiBFdmVudEVtaXR0ZXI8b2JqZWN0PiA9IG5ldyBFdmVudEVtaXR0ZXI8b2JqZWN0PigpO1xyXG4gIEBPdXRwdXQoKSBjYW5jZWw6IEV2ZW50RW1pdHRlcjxvYmplY3Q+ID0gbmV3IEV2ZW50RW1pdHRlcjxvYmplY3Q+KCk7XHJcbiAgQE91dHB1dCgpIGRvbmU6IEV2ZW50RW1pdHRlcjxvYmplY3Q+ID0gbmV3IEV2ZW50RW1pdHRlcjxvYmplY3Q+KCk7XHJcbiAgQE91dHB1dCgpIHNob3c6IEV2ZW50RW1pdHRlcjxvYmplY3Q+ID0gbmV3IEV2ZW50RW1pdHRlcjxvYmplY3Q+KCk7XHJcblxyXG4gIHByaXZhdGUgX3ZhbHVlID0gJzEyOjAwQU0nO1xyXG4gIHByaXZhdGUgX2NvbnRlbnRSZWY6IENvbXBvbmVudFJlZjxNZGJUaW1lUGlja2VyQ29udGVudENvbXBvbmVudD47XHJcbiAgcHJpdmF0ZSBfb3ZlcmxheVJlZjogT3ZlcmxheVJlZiB8IG51bGw7XHJcbiAgcHJpdmF0ZSBfcG9ydGFsOiBDb21wb25lbnRQb3J0YWw8TWRiVGltZVBpY2tlckNvbnRlbnRDb21wb25lbnQ+O1xyXG4gIHB1YmxpYyBpbnB1dDogYW55O1xyXG5cclxuICBwdWJsaWMgX3NlbGVjdGlvbkNoYW5nZSQgPSBuZXcgU3ViamVjdDxzdHJpbmc+KCk7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBfb3ZlcmxheTogT3ZlcmxheSxcclxuICAgIHByaXZhdGUgX3ZjcjogVmlld0NvbnRhaW5lclJlZiAvLyBwcml2YXRlIF9jZFJlZjogQ2hhbmdlRGV0ZWN0b3JSZWZcclxuICApIHt9XHJcblxyXG4gIHByb3RlY3RlZCBfcGF0Y2hJbnB1dFZhbHVlcygpIHtcclxuICAgIHRoaXMuX2NvbnRlbnRSZWYuaW5zdGFuY2UucGlja2VyID0gdGhpcztcclxuICAgIHRoaXMuX2NvbnRlbnRSZWYuaW5zdGFuY2UuYXV0b0Nsb3NlID0gdGhpcy5hdXRvQ2xvc2U7XHJcbiAgICB0aGlzLl9jb250ZW50UmVmLmluc3RhbmNlLmNsZWFyQnV0dG9uID0gdGhpcy5jbGVhckJ1dHRvbjtcclxuICAgIHRoaXMuX2NvbnRlbnRSZWYuaW5zdGFuY2UuY2xvc2VCdXR0b24gPSB0aGlzLmNsb3NlQnV0dG9uO1xyXG4gICAgdGhpcy5fY29udGVudFJlZi5pbnN0YW5jZS5va0J1dHRvbiA9IHRoaXMub2tCdXR0b247XHJcbiAgICB0aGlzLl9jb250ZW50UmVmLmluc3RhbmNlLnJvdW5kaW5nID0gdGhpcy5yb3VuZGluZztcclxuICAgIHRoaXMuX2NvbnRlbnRSZWYuaW5zdGFuY2UudHdlbHZlSG91ciA9IHRoaXMudHdlbHZlSG91cjtcclxuICAgIHRoaXMuX2NvbnRlbnRSZWYuaW5zdGFuY2UudmFsdWUgPSB0aGlzLl90aW1lVG9PYmoodGhpcy5fdmFsdWUpO1xyXG5cclxuICAgIGlmICh0aGlzLm1heCkge1xyXG4gICAgICB0aGlzLl9jb250ZW50UmVmLmluc3RhbmNlLm1heCA9IHRoaXMuX3RpbWVUb09iaih0aGlzLm1heCk7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5taW4pIHtcclxuICAgICAgdGhpcy5fY29udGVudFJlZi5pbnN0YW5jZS5taW4gPSB0aGlzLl90aW1lVG9PYmoodGhpcy5taW4pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIF90aW1lVG9PYmoodGltZTogYW55KTogU2VsZWN0ZWRUaW1lIHtcclxuICAgIGNvbnN0IHJvdW5kID0gKHg6IG51bWJlciwgcm91bmRCeTogbnVtYmVyKSA9PiB7XHJcbiAgICAgIHJldHVybiB4ICUgcm91bmRCeSA8IE1hdGgucm91bmQocm91bmRCeSAvIDIpXHJcbiAgICAgICAgPyB4ICUgcm91bmRCeSA9PT0gMFxyXG4gICAgICAgICAgPyB4XHJcbiAgICAgICAgICA6IE1hdGguY2VpbCh4IC8gcm91bmRCeSkgKiByb3VuZEJ5XHJcbiAgICAgICAgOiBNYXRoLmZsb29yKHggLyByb3VuZEJ5KSAqIHJvdW5kQnk7XHJcbiAgICB9O1xyXG5cclxuICAgIGZ1bmN0aW9uIHRvU3RyaW5nKHZhbDogbnVtYmVyKSB7XHJcbiAgICAgIHJldHVybiB2YWwgPCAxMCA/IGAwJHt2YWx9YCA6IGAke3ZhbH1gO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGhvdXIgPSBOdW1iZXIodGltZS5zcGxpdCgnOicpWzBdKTtcclxuICAgIGxldCBtaW51dGUgPSBOdW1iZXIodGltZS5zcGxpdCgnOicpWzFdLm1hdGNoKC9cXGQrL2cpKTtcclxuICAgIGNvbnN0IGFtcG0gPSB0aW1lLm1hdGNoKC9BTXxQTS8pIHx8IFsnJ107XHJcblxyXG4gICAgaWYgKHRoaXMucm91bmRpbmcpIHtcclxuICAgICAgbWludXRlID0gcm91bmQobWludXRlLCB0aGlzLnJvdW5kaW5nKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBoOiB0b1N0cmluZyhob3VyKSxcclxuICAgICAgbTogdG9TdHJpbmcobWludXRlKSxcclxuICAgICAgYW1wbTogYW1wbVswXSxcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBvcGVuKCk6IHZvaWQge1xyXG4gICAgbGV0IG92ZXJsYXlSZWYgPSB0aGlzLl9vdmVybGF5UmVmO1xyXG4gICAgaWYgKCFvdmVybGF5UmVmKSB7XHJcbiAgICAgIHRoaXMuX3BvcnRhbCA9IG5ldyBDb21wb25lbnRQb3J0YWwoTWRiVGltZVBpY2tlckNvbnRlbnRDb21wb25lbnQsIHRoaXMuX3Zjcik7XHJcbiAgICAgIG92ZXJsYXlSZWYgPSB0aGlzLl9vdmVybGF5LmNyZWF0ZSh0aGlzLl9nZXRPdmVybGF5Q29uZmlnKCkpO1xyXG5cclxuICAgICAgdGhpcy5fb3ZlcmxheVJlZiA9IG92ZXJsYXlSZWY7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKG92ZXJsYXlSZWYgJiYgdGhpcy5fb3ZlcmxheVJlZiAmJiAhb3ZlcmxheVJlZi5oYXNBdHRhY2hlZCgpKSB7XHJcbiAgICAgIHRoaXMuX2NvbnRlbnRSZWYgPSB0aGlzLl9vdmVybGF5UmVmLmF0dGFjaCh0aGlzLl9wb3J0YWwpO1xyXG4gICAgICB0aGlzLl9wYXRjaElucHV0VmFsdWVzKCk7XHJcbiAgICAgIHRoaXMuX2xpc3RlblRvT3V0c2lkZUNsaWNrKCk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5fZW1pdFRpbWVTaG93RXZlbnQodGhpcy5fdGltZVRvT2JqKHRoaXMuX3ZhbHVlKSk7XHJcbiAgfVxyXG5cclxuICBjbG9zZShkb25lQ2xpY2tlZD86IGJvb2xlYW4sIHZhbHVlPzogU2VsZWN0ZWRUaW1lKSB7XHJcbiAgICBpZiAodGhpcy5fb3ZlcmxheVJlZiAmJiB0aGlzLl9vdmVybGF5UmVmLmhhc0F0dGFjaGVkKCkpIHtcclxuICAgICAgaWYgKCFkb25lQ2xpY2tlZCkge1xyXG4gICAgICAgIHRoaXMuX2VtaXRUaW1lQ2FuY2VsRXZlbnQodmFsdWUgfHwgdGhpcy5fdGltZVRvT2JqKHRoaXMuX3ZhbHVlKSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHRoaXMuX2Rlc3Ryb3lPdmVybGF5KCk7XHJcbiAgfVxyXG5cclxuICBfZW1pdFRpbWVDaGFuZ2VFdmVudCh2YWx1ZTogU2VsZWN0ZWRUaW1lKSB7XHJcbiAgICB0aGlzLnRpbWVDaGFuZ2UuZW1pdCh7IHN0YXR1czogJ2NoYW5nZScsIHZhbHVlIH0pO1xyXG4gIH1cclxuXHJcbiAgX2VtaXRUaW1lQ2FuY2VsRXZlbnQodmFsdWU6IFNlbGVjdGVkVGltZSkge1xyXG4gICAgdGhpcy5jYW5jZWwuZW1pdCh7IHN0YXR1czogJ2NhbmNlbCcsIHZhbHVlIH0pO1xyXG4gIH1cclxuXHJcbiAgX2VtaXRUaW1lRG9uZUV2ZW50KHZhbHVlOiBTZWxlY3RlZFRpbWUpIHtcclxuICAgIGNvbnN0IHsgaCwgbSwgYW1wbSB9ID0gdmFsdWU7XHJcbiAgICB0aGlzLmRvbmUuZW1pdCh7IHN0YXR1czogJ2RvbmUnLCB2YWx1ZSB9KTtcclxuICAgIHRoaXMuX3NlbGVjdGlvbkNoYW5nZSQubmV4dCh0aGlzLnR3ZWx2ZUhvdXIgPyBgJHtofToke219JHthbXBtfWAgOiBgJHtofToke219YCk7XHJcbiAgfVxyXG5cclxuICBfZW1pdFRpbWVTaG93RXZlbnQodmFsdWU6IFNlbGVjdGVkVGltZSkge1xyXG4gICAgdGhpcy5zaG93LmVtaXQoeyBzdGF0dXM6ICdvcGVuJywgdmFsdWUgfSk7XHJcbiAgfVxyXG5cclxuICBfc2V0VmFsdWUodmFsdWU6IHN0cmluZykge1xyXG4gICAgaWYgKHZhbHVlKSB7XHJcbiAgICAgIHRoaXMuX3ZhbHVlID0gdmFsdWU7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLl92YWx1ZSA9ICcxMjowMEFNJztcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNldElucHV0KGlucHV0OiBhbnkpIHtcclxuICAgIHRoaXMuaW5wdXQgPSBpbnB1dDtcclxuICAgIGlucHV0Ll92YWx1ZUNoYW5nZS5zdWJzY3JpYmUoKHZhbDogYW55KSA9PiB7XHJcbiAgICAgIGNvbnN0IG1hdGNoID0gdmFsLm1hdGNoKC9cXGRcXGQ6XFxkXFxkKEFNfFBNKT8vZ2kpO1xyXG4gICAgICBpZiAobWF0Y2gpIHtcclxuICAgICAgICB0aGlzLl92YWx1ZSA9IG1hdGNoWzBdO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuX3ZhbHVlID0gJzEyOjAwQU0nO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIG9uQ2hhbmdlQ2I6IChfOiBhbnkpID0+IHZvaWQgPSAoKSA9PiB7fTtcclxuICBvblRvdWNoZWRDYjogKCkgPT4gdm9pZCA9ICgpID0+IHt9O1xyXG5cclxuICByZWdpc3Rlck9uQ2hhbmdlKGZuOiBhbnkpOiB2b2lkIHtcclxuICAgIHRoaXMub25DaGFuZ2VDYiA9IGZuO1xyXG4gIH1cclxuXHJcbiAgcmVnaXN0ZXJPblRvdWNoZWQoZm46IGFueSk6IHZvaWQge1xyXG4gICAgdGhpcy5vblRvdWNoZWRDYiA9IGZuO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfZ2V0T3ZlcmxheUNvbmZpZygpOiBPdmVybGF5Q29uZmlnIHtcclxuICAgIGNvbnN0IHBvc2l0aW9uU3RyYXRlZ3kgPSB0aGlzLl9vdmVybGF5XHJcbiAgICAgIC5wb3NpdGlvbigpXHJcbiAgICAgIC5nbG9iYWwoKVxyXG4gICAgICAuY2VudGVySG9yaXpvbnRhbGx5KClcclxuICAgICAgLmNlbnRlclZlcnRpY2FsbHkoKTtcclxuICAgIGNvbnN0IG92ZXJsYXlDb25maWcgPSBuZXcgT3ZlcmxheUNvbmZpZyh7XHJcbiAgICAgIGhhc0JhY2tkcm9wOiB0cnVlLFxyXG4gICAgICBzY3JvbGxTdHJhdGVneTogdGhpcy5fb3ZlcmxheS5zY3JvbGxTdHJhdGVnaWVzLmJsb2NrKCksXHJcbiAgICAgIHBvc2l0aW9uU3RyYXRlZ3ksXHJcbiAgICB9KTtcclxuICAgIHJldHVybiBvdmVybGF5Q29uZmlnO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfZGVzdHJveU92ZXJsYXkoKSB7XHJcbiAgICBpZiAodGhpcy5fb3ZlcmxheVJlZikge1xyXG4gICAgICB0aGlzLl9vdmVybGF5UmVmLmRpc3Bvc2UoKTtcclxuICAgICAgdGhpcy5fb3ZlcmxheVJlZiA9IG51bGw7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIF9saXN0ZW5Ub091dHNpZGVDbGljaygpIHtcclxuICAgIGlmICh0aGlzLl9vdmVybGF5UmVmKSB7XHJcbiAgICAgIG1lcmdlKFxyXG4gICAgICAgIHRoaXMuX292ZXJsYXlSZWYuYmFja2Ryb3BDbGljaygpLFxyXG4gICAgICAgIHRoaXMuX292ZXJsYXlSZWYuZGV0YWNobWVudHMoKSxcclxuICAgICAgICB0aGlzLl9vdmVybGF5UmVmLmtleWRvd25FdmVudHMoKS5waXBlKFxyXG4gICAgICAgICAgZmlsdGVyKChldmVudDogS2V5Ym9hcmRFdmVudCkgPT4ge1xyXG4gICAgICAgICAgICAvLyBDbG9zaW5nIG9uIGFsdCArIHVwIGlzIG9ubHkgdmFsaWQgd2hlbiB0aGVyZSdzIGFuIGlucHV0IGFzc29jaWF0ZWQgd2l0aCB0aGUgZGF0ZXBpY2tlci5cclxuICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBkZXByZWNhdGlvblxyXG4gICAgICAgICAgICByZXR1cm4gZXZlbnQua2V5Q29kZSA9PT0gRVNDQVBFO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICApXHJcbiAgICAgICkuc3Vic2NyaWJlKGV2ZW50ID0+IHtcclxuICAgICAgICBpZiAoZXZlbnQpIHtcclxuICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuY2xvc2UoKTtcclxuICAgICAgICB0aGlzLl9kZXN0cm95T3ZlcmxheSgpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCkge1xyXG4gICAgdGhpcy5fZGVzdHJveU92ZXJsYXkoKTtcclxuICB9XHJcbn1cclxuIl19